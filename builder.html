<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3×3 Builder — Tsun</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0a;
    --surface: #111111;
    --surface2: #1a1a1a;
    --border: #2a2a2a;
    --text: #e8e4dc;
    --muted: #6b6560;
    --accent: #c9a96e;
    --accent2: #8b5e3c;
    --danger: #9b4040;
    --blush: #c97070;
    --success: #6e9b6e;
    --card-shadow: 0 4px 24px rgba(0,0,0,0.6);
    --radius: 3px;
    --transition: 0.2s cubic-bezier(0.4,0,0.2,1);
  }
  [data-theme="light"] {
    --bg: #f5f0e8;
    --surface: #ede8df;
    --surface2: #e5dfd4;
    --border: #cfc8bc;
    --text: #1a1714;
    --muted: #8a8278;
    --accent: #8b5e2c;
    --accent2: #c9a96e;
    --danger: #9b4040;
    --blush: #c97070;
    --success: #5a7a5a;
    --card-shadow: 0 4px 24px rgba(0,0,0,0.15);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { scroll-behavior: smooth; }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 13px;
    line-height: 1.6;
    transition: background var(--transition), color var(--transition);
  }

  header {
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 1px solid var(--border);
    padding: 0 2rem;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    backdrop-filter: blur(12px);
    background: color-mix(in srgb, var(--bg) 90%, transparent);
  }

  .logo {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.8rem;
    font-weight: 300;
    letter-spacing: 0.15em;
    color: var(--accent);
    text-decoration: none;
    display: flex;
    align-items: baseline;
    gap: 2px;
  }

  .header-right { display: flex; align-items: center; gap: 1rem; }

  .header-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    cursor: pointer;
    padding: 6px 12px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.1em;
    transition: all var(--transition);
    text-transform: uppercase;
    text-decoration: none;
    display: inline-block;
  }
  .header-btn:hover { border-color: var(--accent); color: var(--accent); }

  .user-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 12px;
    border: 1px solid var(--border);
    font-size: 11px;
    color: var(--text);
    cursor: pointer;
    transition: all var(--transition);
  }
  .user-badge:hover { border-color: var(--accent); }
  .user-badge img {
    width: 20px;
    height: 20px;
    border-radius: 50%;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
  }

  .page-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(2rem, 4vw, 3.5rem);
    font-weight: 300;
    margin-bottom: 0.5rem;
    letter-spacing: -0.01em;
  }

  .page-subtitle {
    color: var(--blush);
    font-size: 11px;
    letter-spacing: 0.1em;
    margin-bottom: 2rem;
    font-style: italic;
    opacity: 0.8;
  }

  .builder-layout {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 2rem;
    align-items: start;
  }

  /* SEARCH SECTION */
  .search-section {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .search-label {
    font-size: 10px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 0.8rem;
    display: block;
  }

  .search-wrap {
    position: relative;
  }

  .search-input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 14px;
    padding: 12px 40px 12px 16px;
    outline: none;
    transition: border-color var(--transition);
  }
  .search-input:focus { border-color: var(--accent); }

  .search-icon {
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    pointer-events: none;
  }

  .autocomplete-dropdown {
    position: absolute;
    top: calc(100% + 4px);
    left: 0; right: 0;
    background: var(--surface);
    border: 1px solid var(--border);
    z-index: 200;
    max-height: 320px;
    overflow-y: auto;
    display: none;
  }
  .autocomplete-dropdown.open { display: block; }

  .autocomplete-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 16px;
    cursor: pointer;
    transition: background var(--transition);
    border-bottom: 1px solid var(--border);
  }
  .autocomplete-item:last-child { border-bottom: none; }
  .autocomplete-item:hover { background: var(--surface2); }

  .autocomplete-thumb {
    width: 32px;
    height: 44px;
    object-fit: cover;
    flex-shrink: 0;
    background: var(--surface2);
  }

  .autocomplete-info .name { color: var(--text); font-size: 13px; }
  .autocomplete-info .meta { color: var(--muted); font-size: 11px; }

  /* GRID */
  .grid-container {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 2rem;
  }

  .grid-3x3 {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 2rem;
  }

  .grid-slot {
    aspect-ratio: 2/3;
    background: var(--bg);
    border: 2px dashed var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all var(--transition);
    position: relative;
    overflow: hidden;
  }
  .grid-slot:hover {
    border-color: var(--accent);
  }
  .grid-slot.filled {
    border-style: solid;
    border-color: var(--accent);
  }
  .grid-slot img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  .grid-slot .placeholder {
    color: var(--muted);
    font-size: 24px;
  }
  .grid-slot .remove-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 24px;
    height: 24px;
    background: var(--danger);
    color: white;
    border: none;
    cursor: pointer;
    font-size: 16px;
    line-height: 1;
    opacity: 0;
    transition: opacity var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .grid-slot:hover .remove-btn {
    opacity: 1;
  }

  .grid-actions {
    display: flex;
    gap: 10px;
  }

  .btn {
    padding: 12px 20px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all var(--transition);
    background: none;
    color: var(--text);
  }
  .btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }
  .btn.primary {
    background: var(--accent);
    color: var(--bg);
    border-color: var(--accent);
  }
  .btn.primary:hover {
    background: var(--accent2);
    border-color: var(--accent2);
  }
  .btn.success {
    background: var(--success);
    color: var(--bg);
    border-color: var(--success);
  }
  .btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  /* SIDEBAR */
  .sidebar {
    position: sticky;
    top: 72px;
  }

  .saved-grids {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 1.5rem;
  }

  .sidebar-title {
    font-size: 11px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 1rem;
  }

  .grid-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .grid-item {
    padding: 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all var(--transition);
  }
  .grid-item:hover {
    border-color: var(--accent);
  }

  .grid-item-title {
    font-size: 12px;
    margin-bottom: 6px;
  }

  .grid-item-meta {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 0.05em;
  }

  .grid-item-preview {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2px;
    margin-top: 8px;
  }

  .grid-item-preview img {
    width: 100%;
    aspect-ratio: 2/3;
    object-fit: cover;
  }

  .empty-state {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--muted);
    font-size: 11px;
    font-style: italic;
  }

  /* MODAL */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(4px);
    z-index: 500;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }
  .modal-overlay.open { display: flex; }

  .modal-content {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 2rem;
    max-width: 500px;
    width: 100%;
    box-shadow: var(--card-shadow);
    position: relative;
  }

  .modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    color: var(--muted);
    font-size: 24px;
    cursor: pointer;
    line-height: 1;
    transition: color var(--transition);
  }
  .modal-close:hover { color: var(--text); }

  .modal-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.8rem;
    font-weight: 300;
    margin-bottom: 1rem;
  }

  .modal-input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    padding: 10px 14px;
    margin-bottom: 1rem;
    outline: none;
  }
  .modal-input:focus { border-color: var(--accent); }

  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }

  .grid-preview-modal .modal-content {
    max-width: 700px;
  }

  .grid-preview-canvas {
    width: 100%;
    display: block;
    margin-bottom: 1rem;
    box-shadow: var(--card-shadow);
  }

  .notif {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 12px 20px;
    font-size: 11px;
    letter-spacing: 0.08em;
    box-shadow: var(--card-shadow);
    z-index: 1000;
    animation: slideIn 0.3s ease;
    max-width: 320px;
  }
  .notif.blush { border-color: var(--blush); color: var(--blush); }
  .notif.success { border-color: var(--success); color: var(--success); }
  @keyframes slideIn {
    from { transform: translateY(100px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  @media (max-width: 1024px) {
    .builder-layout {
      grid-template-columns: 1fr;
    }
    .sidebar {
      position: static;
    }
  }

  @media (max-width: 768px) {
    .container { padding: 1rem; }
    header { padding: 0 1rem; }
    .grid-container { padding: 1rem; }
  }
</style>
</head>
<body>

<header>
  <a href="index.html" class="logo">Tsun</a>
  <div class="header-right">
    <a href="index.html" class="header-btn">← Browse</a>
    <button class="header-btn" id="themeToggle">Dark</button>
    <div class="user-badge" id="userBadge" style="display: none;">
      <img src="" alt="" id="userAvatar">
      <span id="userName"></span>
    </div>
    <button class="header-btn" id="loginBtn">Login</button>
  </div>
</header>

<div class="container">
  <h1 class="page-title">3×3 Grid Builder</h1>
  <p class="page-subtitle">fine, make your stupid collage. i'll even save it for you...</p>

  <div class="builder-layout">
    <div class="main-area">
      <div class="search-section">
        <label class="search-label">Search manga to add</label>
        <div class="search-wrap">
          <input type="text" class="search-input" id="searchInput" placeholder="search... whatever">
          <span class="search-icon">⌕</span>
          <div class="autocomplete-dropdown" id="autocomplete"></div>
        </div>
      </div>

      <div class="grid-container">
        <div class="grid-3x3" id="grid"></div>
        <div class="grid-actions">
          <button class="btn primary" id="downloadBtn" disabled>Download PNG</button>
          <button class="btn success" id="saveBtn" disabled>Save Grid</button>
          <button class="btn" id="clearBtn">Clear All</button>
        </div>
      </div>
    </div>

    <div class="sidebar">
      <div class="saved-grids">
        <h3 class="sidebar-title">Your Saved Grids</h3>
        <div class="grid-list" id="gridList"></div>
      </div>
    </div>
  </div>
</div>

<!-- Save Modal -->
<div class="modal-overlay" id="saveModal">
  <div class="modal-content">
    <button class="modal-close" id="closeSaveModal">×</button>
    <h2 class="modal-title">Save Grid</h2>
    <input type="text" class="modal-input" id="gridNameInput" placeholder="name your grid... (optional)">
    <div class="modal-actions">
      <button class="btn" id="cancelSave">Cancel</button>
      <button class="btn primary" id="confirmSave">Save</button>
    </div>
  </div>
</div>

<!-- Preview Modal -->
<div class="modal-overlay grid-preview-modal" id="previewModal">
  <div class="modal-content">
    <button class="modal-close" id="closePreviewModal">×</button>
    <h2 class="modal-title" id="previewTitle"></h2>
    <canvas id="previewCanvas" class="grid-preview-canvas"></canvas>
    <div class="modal-actions">
      <button class="btn" id="deletePreviewGrid">Delete</button>
      <button class="btn primary" id="downloadPreviewGrid">Download</button>
    </div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
const BLANK_SVG = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg"%3E%3C/svg%3E';

// State
let currentGrid = Array(9).fill(null);
let savedGrids = [];
let currentUser = null;

// Load saved user
const savedUser = localStorage.getItem('tsun_user');
if (savedUser) {
  currentUser = JSON.parse(savedUser);
  updateUserUI();
}

function updateUserUI() {
  if (currentUser) {
    $('loginBtn').style.display = 'none';
    $('userBadge').style.display = 'flex';
    $('userAvatar').src = currentUser.picture;
    $('userName').textContent = currentUser.name.split(' ')[0];
  } else {
    $('loginBtn').style.display = 'inline-block';
    $('userBadge').style.display = 'none';
  }
}

$('loginBtn').addEventListener('click', () => {
  window.location.href = 'index.html';
});

$('userBadge').addEventListener('click', () => {
  if (confirm("Log out? (Your grids are saved locally)")) {
    currentUser = null;
    localStorage.removeItem('tsun_user');
    updateUserUI();
    showNotif("Whatever. Come back when you feel like it.", 'blush');
  }
});

// Theme
const themeToggle = $('themeToggle');
const html = document.documentElement;
const savedTheme = localStorage.getItem('tsun_theme') || 'dark';
html.setAttribute('data-theme', savedTheme);
themeToggle.textContent = savedTheme === 'dark' ? 'Dark' : 'Light';

themeToggle.addEventListener('click', () => {
  const current = html.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  themeToggle.textContent = next === 'dark' ? 'Dark' : 'Light';
  localStorage.setItem('tsun_theme', next);
});

// Load current grid from localStorage
function loadCurrentGrid() {
  const saved = localStorage.getItem('tsun_current_grid');
  if (saved) {
    currentGrid = JSON.parse(saved);
    renderGrid();
  }
}

// Save current grid to localStorage
function saveCurrentGrid() {
  localStorage.setItem('tsun_current_grid', JSON.stringify(currentGrid));
}

// Load saved grids
function loadSavedGrids() {
  const saved = localStorage.getItem('tsun_saved_grids');
  if (saved) {
    savedGrids = JSON.parse(saved);
    renderSavedGrids();
  }
}

function saveSavedGrids() {
  localStorage.setItem('tsun_saved_grids', JSON.stringify(savedGrids));
}

// Render grid
function renderGrid() {
  const gridEl = $('grid');
  gridEl.innerHTML = currentGrid.map((manga, i) => {
    if (manga) {
      return `
        <div class="grid-slot filled" data-index="${i}">
          <img src="${manga.image}" alt="${manga.title}">
          <button class="remove-btn" data-index="${i}">×</button>
        </div>
      `;
    } else {
      return `
        <div class="grid-slot" data-index="${i}">
          <span class="placeholder">+</span>
        </div>
      `;
    }
  }).join('');

  // Add click handlers
  gridEl.querySelectorAll('.grid-slot').forEach(slot => {
    const index = parseInt(slot.dataset.index);
    if (!currentGrid[index]) {
      slot.addEventListener('click', () => {
        showNotif("Search for a manga above to add it here.", 'blush');
      });
    }
  });

  gridEl.querySelectorAll('.remove-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const index = parseInt(btn.dataset.index);
      currentGrid[index] = null;
      saveCurrentGrid();
      renderGrid();
      updateButtons();
    });
  });

  updateButtons();
}

function updateButtons() {
  const filled = currentGrid.filter(m => m !== null).length;
  $('downloadBtn').disabled = filled !== 9;
  $('saveBtn').disabled = filled !== 9;
}

// Search
const searchInput = $('searchInput');
const autocomplete = $('autocomplete');
let searchTimeout;
let acResults = [];

searchInput.addEventListener('input', e => {
  clearTimeout(searchTimeout);
  const query = e.target.value.trim();
  if (query.length < 2) {
    autocomplete.classList.remove('open');
    return;
  }
  searchTimeout = setTimeout(() => searchManga(query), 300);
});

async function searchManga(query) {
  try {
    const url = `https://api.jikan.moe/v4/manga?q=${encodeURIComponent(query)}&limit=8&type=manga&sfw=false`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Search failed');
    const data = await res.json();
    acResults = data.data || [];
    renderAutocomplete();
  } catch(e) {
    console.warn('Search error:', e);
  }
}

function renderAutocomplete() {
  if (!acResults.length) {
    autocomplete.classList.remove('open');
    return;
  }
  autocomplete.innerHTML = acResults.map((m, i) => `
    <div class="autocomplete-item" data-index="${i}">
      <img class="autocomplete-thumb" src="${m.images?.jpg?.small_image_url || BLANK_SVG}" alt="">
      <div class="autocomplete-info">
        <div class="name">${escHtml(m.title)}</div>
        <div class="meta">${m.type || 'Manga'} · ${m.volumes || '?'} vol</div>
      </div>
    </div>
  `).join('');
  autocomplete.classList.add('open');

  autocomplete.querySelectorAll('.autocomplete-item').forEach(item => {
    item.addEventListener('click', () => {
      const manga = acResults[parseInt(item.dataset.index)];
      addMangaToGrid(manga);
    });
  });
}

function addMangaToGrid(manga) {
  const firstEmpty = currentGrid.findIndex(m => m === null);
  if (firstEmpty === -1) {
    showNotif("Grid is full. Remove a manga first, genius.", 'blush');
    return;
  }

  currentGrid[firstEmpty] = {
    id: manga.mal_id,
    title: manga.title,
    image: manga.images?.jpg?.image_url || BLANK_SVG
  };

  saveCurrentGrid();
  renderGrid();
  searchInput.value = '';
  autocomplete.classList.remove('open');
  
  if (currentGrid.filter(m => m !== null).length === 9) {
    showNotif("There. Your grid is complete. Happy?", 'success');
  }
}

document.addEventListener('click', e => {
  if (!searchInput.contains(e.target) && !autocomplete.contains(e.target)) {
    autocomplete.classList.remove('open');
  }
});

// Check URL for manga to add
const urlParams = new URLSearchParams(window.location.search);
const addMangaId = urlParams.get('add');
if (addMangaId) {
  fetch(`https://api.jikan.moe/v4/manga/${addMangaId}`)
    .then(r => r.json())
    .then(data => {
      if (data.data) {
        addMangaToGrid(data.data);
        // Clean URL
        window.history.replaceState({}, '', 'builder.html');
      }
    })
    .catch(e => console.warn('Failed to add manga:', e));
}

// Clear grid
$('clearBtn').addEventListener('click', () => {
  if (confirm("Clear the entire grid? You'll lose everything.")) {
    currentGrid = Array(9).fill(null);
    saveCurrentGrid();
    renderGrid();
    showNotif("Fine. It's gone.", 'blush');
  }
});

// Download grid
$('downloadBtn').addEventListener('click', async () => {
  const canvas = document.createElement('canvas');
  const cellSize = 200;
  const gap = 4;
  const canvasW = cellSize * 3 + gap * 2;
  const canvasH = cellSize * 1.5 * 3 + gap * 2;
  canvas.width = canvasW;
  canvas.height = canvasH;
  const ctx = canvas.getContext('2d');
  
  ctx.fillStyle = '#0a0a0a';
  ctx.fillRect(0, 0, canvasW, canvasH);

  const imagePromises = currentGrid.map(manga => new Promise(resolve => {
    if (!manga) return resolve(null);
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => resolve(img);
    img.onerror = () => resolve(null);
    img.src = manga.image;
  }));

  const images = await Promise.all(imagePromises);

  images.forEach((img, i) => {
    const col = i % 3, row = Math.floor(i / 3);
    const x = col * (cellSize + gap);
    const y = row * (cellSize * 1.5 + gap);
    const w = cellSize, h = cellSize * 1.5;

    if (img) {
      const srcAR = img.naturalWidth / img.naturalHeight;
      const dstAR = w / h;
      let sx, sy, sw, sh;
      if (srcAR > dstAR) {
        sh = img.naturalHeight; sw = sh * dstAR;
        sx = (img.naturalWidth - sw) / 2; sy = 0;
      } else {
        sw = img.naturalWidth; sh = sw / dstAR;
        sx = 0; sy = (img.naturalHeight - sh) / 2;
      }
      ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
    }
  });

  // Grid lines
  ctx.strokeStyle = 'rgba(0,0,0,0.9)';
  ctx.lineWidth = gap;
  for (let i = 1; i < 3; i++) {
    const xLine = i * (cellSize + gap) - gap / 2;
    ctx.beginPath(); ctx.moveTo(xLine, 0); ctx.lineTo(xLine, canvasH); ctx.stroke();
    const yLine = i * (cellSize * 1.5 + gap) - gap / 2;
    ctx.beginPath(); ctx.moveTo(0, yLine); ctx.lineTo(canvasW, yLine); ctx.stroke();
  }

  const link = document.createElement('a');
  link.download = `tsun-3x3-${Date.now()}.png`;
  link.href = canvas.toDataURL('image/png');
  link.click();
  
  showNotif("Downloaded. You better not lose it.", 'success');
});

// Save grid
$('saveBtn').addEventListener('click', () => {
  $('saveModal').classList.add('open');
  $('gridNameInput').value = '';
  $('gridNameInput').focus();
});

$('confirmSave').addEventListener('click', () => {
  const name = $('gridNameInput').value.trim() || `Grid ${savedGrids.length + 1}`;
  const newGrid = {
    id: Date.now(),
    name: name,
    manga: [...currentGrid],
    createdAt: new Date().toISOString(),
    userId: currentUser?.id || null
  };
  
  savedGrids.unshift(newGrid);
  saveSavedGrids();
  renderSavedGrids();
  
  $('saveModal').classList.remove('open');
  showNotif("Saved. Not that I care.", 'success');
  
  // Optionally sync to backend if user is logged in
  if (currentUser) {
    syncToBackend(newGrid);
  }
});

$('cancelSave').addEventListener('click', () => {
  $('saveModal').classList.remove('open');
});

$('closeSaveModal').addEventListener('click', () => {
  $('saveModal').classList.remove('open');
});

// Render saved grids
function renderSavedGrids() {
  const gridList = $('gridList');
  
  if (!savedGrids.length) {
    gridList.innerHTML = '<div class="empty-state">no saved grids yet. get to work.</div>';
    return;
  }

  gridList.innerHTML = savedGrids.map(grid => `
    <div class="grid-item" data-id="${grid.id}">
      <div class="grid-item-title">${escHtml(grid.name)}</div>
      <div class="grid-item-meta">${new Date(grid.createdAt).toLocaleDateString()}</div>
      <div class="grid-item-preview">
        ${grid.manga.map(m => m ? `<img src="${m.image}" alt="${m.title}">` : '').join('')}
      </div>
    </div>
  `).join('');

  gridList.querySelectorAll('.grid-item').forEach(item => {
    item.addEventListener('click', () => {
      const gridId = parseInt(item.dataset.id);
      const grid = savedGrids.find(g => g.id === gridId);
      if (grid) showGridPreview(grid);
    });
  });
}

// Show grid preview
async function showGridPreview(grid) {
  $('previewTitle').textContent = grid.name;
  $('previewModal').classList.add('open');
  
  const canvas = $('previewCanvas');
  const cellSize = 200;
  const gap = 4;
  const canvasW = cellSize * 3 + gap * 2;
  const canvasH = cellSize * 1.5 * 3 + gap * 2;
  canvas.width = canvasW;
  canvas.height = canvasH;
  const ctx = canvas.getContext('2d');
  
  ctx.fillStyle = '#0a0a0a';
  ctx.fillRect(0, 0, canvasW, canvasH);

  const imagePromises = grid.manga.map(manga => new Promise(resolve => {
    if (!manga) return resolve(null);
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => resolve(img);
    img.onerror = () => resolve(null);
    img.src = manga.image;
  }));

  const images = await Promise.all(imagePromises);

  images.forEach((img, i) => {
    const col = i % 3, row = Math.floor(i / 3);
    const x = col * (cellSize + gap);
    const y = row * (cellSize * 1.5 + gap);
    const w = cellSize, h = cellSize * 1.5;

    if (img) {
      const srcAR = img.naturalWidth / img.naturalHeight;
      const dstAR = w / h;
      let sx, sy, sw, sh;
      if (srcAR > dstAR) {
        sh = img.naturalHeight; sw = sh * dstAR;
        sx = (img.naturalWidth - sw) / 2; sy = 0;
      } else {
        sw = img.naturalWidth; sh = sw / dstAR;
        sx = 0; sy = (img.naturalHeight - sh) / 2;
      }
      ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
    }
  });

  ctx.strokeStyle = 'rgba(0,0,0,0.9)';
  ctx.lineWidth = gap;
  for (let i = 1; i < 3; i++) {
    const xLine = i * (cellSize + gap) - gap / 2;
    ctx.beginPath(); ctx.moveTo(xLine, 0); ctx.lineTo(xLine, canvasH); ctx.stroke();
    const yLine = i * (cellSize * 1.5 + gap) - gap / 2;
    ctx.beginPath(); ctx.moveTo(0, yLine); ctx.lineTo(canvasW, yLine); ctx.stroke();
  }

  // Set up download button
  $('downloadPreviewGrid').onclick = () => {
    const link = document.createElement('a');
    link.download = `${grid.name.replace(/[^a-z0-9]/gi, '-')}-tsun-3x3.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
    showNotif("Downloaded. Again.", 'success');
  };

  // Set up delete button
  $('deletePreviewGrid').onclick = () => {
    if (confirm(`Delete "${grid.name}"? This can't be undone.`)) {
      savedGrids = savedGrids.filter(g => g.id !== grid.id);
      saveSavedGrids();
      renderSavedGrids();
      $('previewModal').classList.remove('open');
      showNotif("Deleted. Hope you didn't need that.", 'blush');
    }
  };
}

$('closePreviewModal').addEventListener('click', () => {
  $('previewModal').classList.remove('open');
});

$('previewModal').addEventListener('click', e => {
  if (e.target === $('previewModal')) {
    $('previewModal').classList.remove('open');
  }
});

// Backend sync (placeholder - you'll need to implement the actual API)
async function syncToBackend(grid) {
  // This is where you'd send the grid to your backend
  // Example:
  /*
  try {
    const response = await fetch('YOUR_BACKEND_API/grids', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${currentUser.id}`
      },
      body: JSON.stringify(grid)
    });
    if (response.ok) {
      console.log('Grid synced to backend');
    }
  } catch(e) {
    console.warn('Backend sync failed:', e);
  }
  */
  console.log('Backend sync would happen here for grid:', grid.id);
}

// Utils
function escHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function showNotif(msg, type = '') {
  const el = document.createElement('div');
  el.className = `notif${type ? ' ' + type : ''}`;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3200);
}

// Init
loadCurrentGrid();
loadSavedGrids();
renderGrid();
renderSavedGrids();
</script>
</body>
</html>

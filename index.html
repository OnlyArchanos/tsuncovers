<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tsun — It's not like I archived these for you</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0a;
    --surface: #111111;
    --surface2: #1a1a1a;
    --border: #2a2a2a;
    --text: #e8e4dc;
    --muted: #6b6560;
    --accent: #c9a96e;
    --accent2: #8b5e3c;
    --danger: #9b4040;
    --blush: #c97070;
    --card-shadow: 0 4px 24px rgba(0,0,0,0.6);
    --radius: 3px;
    --transition: 0.2s cubic-bezier(0.4,0,0.2,1);
  }
  [data-theme="light"] {
    --bg: #f5f0e8;
    --surface: #ede8df;
    --surface2: #e5dfd4;
    --border: #cfc8bc;
    --text: #1a1714;
    --muted: #8a8278;
    --accent: #8b5e2c;
    --accent2: #c9a96e;
    --danger: #9b4040;
    --blush: #c97070;
    --card-shadow: 0 4px 24px rgba(0,0,0,0.15);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { scroll-behavior: smooth; }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 13px;
    line-height: 1.6;
    transition: background var(--transition), color var(--transition);
  }

  /* HEADER */
  header {
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 1px solid var(--border);
    padding: 0 2rem;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    backdrop-filter: blur(12px);
    background: color-mix(in srgb, var(--bg) 90%, transparent);
  }

  .logo {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.8rem;
    font-weight: 300;
    letter-spacing: 0.15em;
    color: var(--accent);
    text-decoration: none;
    display: flex;
    align-items: baseline;
    gap: 2px;
  }
  .logo span { color: var(--text); font-style: italic; }
  .logo-blush {
    font-size: 10px;
    letter-spacing: 0.08em;
    color: var(--blush);
    font-family: 'DM Mono', monospace;
    font-style: normal;
    opacity: 0.7;
    margin-left: 6px;
    align-self: center;
  }

  .header-right { display: flex; align-items: center; gap: 1rem; }

  .theme-toggle {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    cursor: pointer;
    padding: 6px 12px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.1em;
    transition: all var(--transition);
    text-transform: uppercase;
  }
  .theme-toggle:hover { border-color: var(--accent); color: var(--accent); }

  /* HERO */
  .hero {
    padding: 5rem 2rem 3rem;
    max-width: 900px;
    margin: 0 auto;
    text-align: center;
  }

  .hero-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(2.5rem, 6vw, 5rem);
    font-weight: 300;
    line-height: 1;
    letter-spacing: -0.02em;
    margin-bottom: 0.5rem;
  }
  .hero-title em { font-style: italic; color: var(--accent); }

  .hero-sub {
    color: var(--muted);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    font-size: 11px;
    margin-bottom: 2.5rem;
  }

  .hero-disclaimer {
    color: var(--blush);
    font-size: 10px;
    letter-spacing: 0.1em;
    margin-top: -1.8rem;
    margin-bottom: 2rem;
    opacity: 0.8;
    font-style: italic;
  }

  .search-wrap {
    position: relative;
    max-width: 560px;
    margin: 0 auto;
  }

  .search-input {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 14px;
    padding: 14px 50px 14px 20px;
    outline: none;
    transition: border-color var(--transition);
    letter-spacing: 0.05em;
  }
  .search-input::placeholder { color: var(--muted); }
  .search-input:focus { border-color: var(--accent); }

  .search-icon {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    pointer-events: none;
    font-size: 16px;
  }

  .autocomplete-dropdown {
    position: absolute;
    top: calc(100% + 4px);
    left: 0; right: 0;
    background: var(--surface);
    border: 1px solid var(--border);
    z-index: 200;
    max-height: 320px;
    overflow-y: auto;
    display: none;
  }
  .autocomplete-dropdown.open { display: block; }

  .autocomplete-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 16px;
    cursor: pointer;
    transition: background var(--transition);
    border-bottom: 1px solid var(--border);
  }
  .autocomplete-item:last-child { border-bottom: none; }
  .autocomplete-item:hover, .autocomplete-item.active { background: var(--surface2); }

  .autocomplete-thumb {
    width: 32px;
    height: 44px;
    object-fit: cover;
    flex-shrink: 0;
    background: var(--surface2);
  }

  .autocomplete-info .name { color: var(--text); font-size: 13px; display: block; }
  .autocomplete-info .meta { color: var(--muted); font-size: 11px; letter-spacing: 0.05em; }

  /* MANGA META CARD */
  .manga-meta {
    max-width: 1200px;
    margin: 0 auto 2rem;
    padding: 0 2rem;
    display: none;
    animation: fadeUp 0.3s ease;
  }
  .manga-meta.visible { display: flex; gap: 2rem; align-items: flex-start; }

  .meta-cover { width: 120px; flex-shrink: 0; }
  .meta-cover img { width: 100%; box-shadow: var(--card-shadow); }

  .meta-info { flex: 1; }

  .meta-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 2.2rem;
    font-weight: 300;
    line-height: 1.1;
    margin-bottom: 0.5rem;
  }

  .meta-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 1rem; }

  .tag {
    font-size: 10px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 3px 8px;
    border: 1px solid var(--border);
    color: var(--muted);
  }
  .tag.accent { border-color: var(--accent); color: var(--accent); }

  .meta-synopsis {
    color: var(--muted);
    font-size: 12px;
    line-height: 1.8;
    max-width: 600px;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .meta-tsun-comment {
    margin-top: 0.6rem;
    color: var(--blush);
    font-size: 10px;
    letter-spacing: 0.08em;
    font-style: italic;
    opacity: 0.9;
  }

  .meta-actions {
    margin-top: 1.2rem;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }

  .btn {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    padding: 8px 18px;
    cursor: pointer;
    border: 1px solid var(--border);
    background: none;
    color: var(--text);
    transition: all var(--transition);
  }
  .btn:hover { border-color: var(--accent); color: var(--accent); }
  .btn.primary { background: var(--accent); border-color: var(--accent); color: #0a0a0a; }
  .btn.primary:hover { background: transparent; color: var(--accent); }
  .btn.danger { border-color: var(--danger); color: var(--danger); }
  .btn.danger:hover { background: var(--danger); color: white; }

  .selection-count { color: var(--muted); font-size: 11px; letter-spacing: 0.1em; }

  /* GALLERY */
  .gallery-section {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem 4rem;
    display: none;
  }
  .gallery-section.visible { display: block; }

  .gallery-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
  }

  .gallery-label { font-size: 11px; letter-spacing: 0.2em; text-transform: uppercase; color: var(--muted); }
  .gallery-label span { color: var(--accent); }

  .covers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 12px;
  }

  .cover-card {
    position: relative;
    cursor: pointer;
    animation: fadeUp 0.3s ease both;
  }

  .cover-card img {
    width: 100%;
    aspect-ratio: 2/3;
    object-fit: cover;
    display: block;
    transition: transform var(--transition), box-shadow var(--transition);
    background: var(--surface);
  }
  .cover-card:hover img { transform: translateY(-4px); box-shadow: 0 12px 32px rgba(0,0,0,0.5); }
  .cover-card.selected img { outline: 2px solid var(--accent); outline-offset: 2px; }

  .cover-select-badge {
    position: absolute;
    top: 6px;
    right: 6px;
    width: 22px;
    height: 22px;
    background: var(--bg);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    opacity: 0;
    transition: opacity var(--transition);
    color: var(--muted);
  }
  .cover-card:hover .cover-select-badge,
  .cover-card.selected .cover-select-badge { opacity: 1; }
  .cover-card.selected .cover-select-badge { background: var(--accent); border-color: var(--accent); color: #0a0a0a; }

  .cover-vol {
    margin-top: 6px;
    font-size: 10px;
    letter-spacing: 0.1em;
    color: var(--muted);
    text-align: center;
    text-transform: uppercase;
  }

  .load-more-wrap { text-align: center; margin-top: 2rem; }

  /* SELECTION TOOLBAR */
  .selection-toolbar {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: var(--surface);
    border-top: 1px solid var(--accent);
    padding: 14px 2rem;
    display: none;
    align-items: center;
    justify-content: space-between;
    z-index: 300;
    animation: slideUp 0.25s ease;
  }
  .selection-toolbar.visible { display: flex; }

  .toolbar-left { display: flex; align-items: center; gap: 1rem; }

  .toolbar-count {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.4rem;
    font-weight: 300;
    color: var(--accent);
  }

  .toolbar-label { font-size: 11px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); }

  .grid-preview {
    display: grid;
    grid-template-columns: repeat(3, 24px);
    grid-template-rows: repeat(3, 24px);
    gap: 2px;
    opacity: 0.6;
  }
  .grid-preview-cell { background: var(--border); transition: background var(--transition); }
  .grid-preview-cell.filled { background: var(--accent); }

  /* LIGHTBOX */
  .lightbox {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.92);
    z-index: 500;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }
  .lightbox.open { display: flex; }

  .lightbox-inner {
    position: relative;
    max-width: 400px;
    width: 100%;
    user-select: none;
  }

  .lightbox-img {
    width: 100%;
    max-height: 80vh;
    object-fit: contain;
    display: block;
    box-shadow: 0 20px 80px rgba(0,0,0,0.8);
    touch-action: pan-y;
  }

  .lightbox-info {
    position: absolute;
    bottom: -2.5rem;
    left: 0; right: 0;
    text-align: center;
    font-size: 11px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.5);
  }

  .lightbox-nav {
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.6);
    width: 44px; height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 18px;
    transition: all var(--transition);
    z-index: 501;
  }
  .lightbox-nav:hover { border-color: var(--accent); color: var(--accent); }
  .lightbox-nav.prev { left: 1.5rem; }
  .lightbox-nav.next { right: 1.5rem; }

  .lightbox-close {
    position: fixed;
    top: 1.5rem; right: 1.5rem;
    background: none;
    border: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.6);
    width: 36px; height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    transition: all var(--transition);
    z-index: 501;
  }
  .lightbox-close:hover { border-color: var(--blush); color: var(--blush); }

  /* GRID MODAL */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 600;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    max-width: 500px;
    width: 100%;
    padding: 2rem;
    animation: fadeUp 0.25s ease;
  }

  .modal-title { font-family: 'Cormorant Garamond', serif; font-size: 1.6rem; font-weight: 300; margin-bottom: 0.3rem; }
  .modal-sub { color: var(--muted); font-size: 11px; letter-spacing: 0.1em; margin-bottom: 1.5rem; font-style: italic; }

  .grid-canvas-wrap { width: 100%; background: #000; margin-bottom: 1.5rem; overflow: hidden; }
  #gridCanvas { width: 100%; height: auto; display: block; }

  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }

  /* DIVIDER */
  .section-divider {
    max-width: 1200px;
    margin: 3rem auto;
    padding: 0 2rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }
  .divider-label { font-size: 11px; letter-spacing: 0.25em; text-transform: uppercase; color: var(--muted); white-space: nowrap; }
  .divider-sub { font-size: 10px; color: var(--blush); font-style: italic; white-space: nowrap; }
  .divider-line { flex: 1; height: 1px; background: var(--border); }

  /* GENRE SECTION */
  .genre-section { max-width: 1200px; margin: 0 auto 4rem; padding: 0 2rem; }
  .genre-block { margin-bottom: 3rem; }

  .genre-header { display: flex; align-items: baseline; justify-content: space-between; margin-bottom: 1.2rem; }

  .genre-title { font-family: 'Cormorant Garamond', serif; font-size: 1.5rem; font-weight: 300; letter-spacing: 0.05em; }
  .genre-title-sub { font-size: 10px; color: var(--blush); letter-spacing: 0.08em; font-style: italic; margin-left: 10px; font-family: 'DM Mono', monospace; font-weight: 300; }

  .genre-nav { display: flex; gap: 6px; }
  .genre-nav-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    width: 28px; height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    transition: all var(--transition);
  }
  .genre-nav-btn:hover { border-color: var(--accent); color: var(--accent); }

  .genre-carousel-outer { overflow: hidden; position: relative; }

  .genre-carousel {
    display: flex;
    gap: 14px;
    transition: transform 0.4s cubic-bezier(0.4,0,0.2,1);
    will-change: transform;
  }

  .genre-card { flex-shrink: 0; width: 140px; cursor: pointer; transition: opacity var(--transition); }
  .genre-card:hover { opacity: 0.85; }

  .genre-card img {
    width: 100%;
    aspect-ratio: 2/3;
    object-fit: cover;
    display: block;
    background: var(--surface);
    box-shadow: var(--card-shadow);
    transition: transform var(--transition);
  }
  .genre-card:hover img { transform: translateY(-4px); }

  .genre-card-title { margin-top: 8px; font-size: 11px; letter-spacing: 0.05em; color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .genre-card-score { font-size: 10px; color: var(--muted); margin-top: 2px; letter-spacing: 0.05em; }
  .genre-card-score .star { color: var(--accent); }

  /* LOADING */
  .loading-ring {
    width: 32px; height: 32px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 3rem auto;
    display: none;
  }
  .loading-ring.visible { display: block; }

  .loading-caption {
    text-align: center;
    color: var(--blush);
    font-size: 11px;
    letter-spacing: 0.1em;
    font-style: italic;
    margin-top: -2rem;
    margin-bottom: 2rem;
    display: none;
  }
  .loading-caption.visible { display: block; }

  .skeleton {
    background: linear-gradient(90deg, var(--surface) 25%, var(--surface2) 50%, var(--surface) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.4s infinite;
  }

  /* EMPTY STATE */
  .empty-state { text-align: center; padding: 4rem 2rem; color: var(--muted); display: none; }
  .empty-state.visible { display: block; }
  .empty-state-title { font-family: 'Cormorant Garamond', serif; font-size: 2rem; font-weight: 300; margin-bottom: 0.5rem; color: var(--text); }
  .empty-state-sub { color: var(--blush); font-style: italic; font-size: 12px; margin-top: 0.5rem; }

  /* NOTIFICATION */
  .notif {
    position: fixed;
    top: 70px; right: 2rem;
    background: var(--surface);
    border: 1px solid var(--accent);
    color: var(--text);
    padding: 10px 16px;
    font-size: 11px;
    letter-spacing: 0.1em;
    z-index: 999;
    animation: slideInRight 0.25s ease, fadeOut 0.3s ease 2.5s both;
    pointer-events: none;
  }

  .notif.blush { border-color: var(--blush); }

  /* ANIMATIONS */
  @keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
  @keyframes fadeOut { to { opacity: 0; } }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

  /* RESPONSIVE */
  @media (max-width: 640px) {
    .hero { padding: 3rem 1.5rem 2rem; }
    .manga-meta.visible { flex-direction: column; padding: 0 1.5rem; }
    .meta-cover { width: 80px; }
    .gallery-section, .genre-section { padding: 0 1.5rem 3rem; }
    .covers-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
    .lightbox-nav { display: none; }
    .selection-toolbar { padding: 12px 1.5rem; flex-wrap: wrap; gap: 10px; }
    .genre-card { width: 120px; }
    header { padding: 0 1.5rem; }
    .logo { font-size: 1.4rem; }
    .toolbar-hint { display: none; }
  }

  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); }
  ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

  #offscreenCanvas { display: none; }
</style>
</head>
<body>

<header>
  <a class="logo" href="#">Ts<span>un</span><span class="logo-blush">...it's not like I made this for you</span></a>
  <div class="header-right">
    <button class="theme-toggle" id="themeToggle">Too bright</button>
  </div>
</header>

<section class="hero">
  <h1 class="hero-title">It's not like I<br><em>saved these for you.</em></h1>
  <p class="hero-sub">I just happened to archive every manga cover ever. Don't read into it.</p>
  <p class="hero-disclaimer">...b-baka. Just search already.</p>
  <div class="search-wrap">
    <input type="text" class="search-input" id="searchInput"
      placeholder="Fine. Type a manga title, I guess..." autocomplete="off" spellcheck="false">
    <span class="search-icon">&#x2315;</span>
    <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
  </div>
</section>

<div class="manga-meta" id="mangaMeta">
  <div class="meta-cover">
    <img id="metaCoverImg" src="" alt="">
  </div>
  <div class="meta-info">
    <h2 class="meta-title" id="metaTitle"></h2>
    <div class="meta-tags" id="metaTags"></div>
    <p class="meta-synopsis" id="metaSynopsis"></p>
    <p class="meta-tsun-comment" id="metaTsunComment"></p>
    <div class="meta-actions">
      <button class="btn" id="selectModeBtn">Pick covers, I suppose</button>
      <span class="selection-count" id="selectionCountLabel" style="display:none"></span>
    </div>
  </div>
</div>

<div id="galleryLoading" class="loading-ring"></div>
<div id="loadingCaption" class="loading-caption">Fetching covers... not because you asked. Just because.</div>

<section class="gallery-section" id="gallerySection">
  <div class="gallery-header">
    <span class="gallery-label" id="galleryLabel">finding covers...</span>
  </div>
  <div class="covers-grid" id="coversGrid"></div>
  <div class="load-more-wrap" id="loadMoreWrap" style="display:none">
    <button class="btn" id="loadMoreBtn">There's more. Not that I'm excited to show you.</button>
  </div>
</section>

<div class="empty-state" id="emptyState">
  <p class="empty-state-title">Nothing found.</p>
  <p>I looked everywhere, okay? Don't blame me.</p>
  <p class="empty-state-sub">...maybe try a different title. I-I'm only suggesting it for your sake.</p>
</div>

<!-- GENRE SECTION -->
<div class="section-divider" id="genreDivider">
  <span class="divider-label">Top manga by genre</span>
  <div class="divider-line"></div>
  <span class="divider-sub">don't thank me</span>
</div>

<section class="genre-section" id="genreSection">
  <div id="genreBlocks"></div>
</section>

<!-- SELECTION TOOLBAR -->
<div class="selection-toolbar" id="selectionToolbar">
  <div class="toolbar-left">
    <div>
      <div class="toolbar-count" id="toolbarCount">0</div>
      <div class="toolbar-label">chosen. happy now?</div>
    </div>
    <div class="grid-preview" id="gridPreview">
      <div class="grid-preview-cell" data-idx="0"></div>
      <div class="grid-preview-cell" data-idx="1"></div>
      <div class="grid-preview-cell" data-idx="2"></div>
      <div class="grid-preview-cell" data-idx="3"></div>
      <div class="grid-preview-cell" data-idx="4"></div>
      <div class="grid-preview-cell" data-idx="5"></div>
      <div class="grid-preview-cell" data-idx="6"></div>
      <div class="grid-preview-cell" data-idx="7"></div>
      <div class="grid-preview-cell" data-idx="8"></div>
    </div>
  </div>
  <div style="display:flex;gap:10px;align-items:center">
    <span class="toolbar-hint" style="font-size:10px;color:var(--muted);letter-spacing:0.1em">Pick exactly 9. I'm not flexible about this.</span>
    <button class="btn primary" id="buildGridBtn" disabled>Build the 3x3 already</button>
    <button class="btn danger" id="clearSelectionBtn">Forget all of this</button>
  </div>
</div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox">
  <button class="lightbox-close" id="lightboxClose">&#x2715;</button>
  <button class="lightbox-nav prev" id="lightboxPrev">&#x2039;</button>
  <div class="lightbox-inner">
    <img class="lightbox-img" id="lightboxImg" src="" alt="" draggable="false">
    <div class="lightbox-info" id="lightboxInfo"></div>
  </div>
  <button class="lightbox-nav next" id="lightboxNext">&#x203A;</button>
</div>

<!-- GRID MODAL -->
<div class="modal-overlay" id="gridModal">
  <div class="modal">
    <h2 class="modal-title">Your 3x3 Grid</h2>
    <p class="modal-sub">I made it for you. Don't get the wrong idea — it took two seconds.</p>
    <div class="grid-canvas-wrap">
      <canvas id="gridCanvas"></canvas>
    </div>
    <div class="modal-actions">
      <button class="btn" id="closeModal">Never mind</button>
      <button class="btn primary" id="downloadGrid">Take it. Fine.</button>
    </div>
  </div>
</div>

<canvas id="offscreenCanvas"></canvas>

<script>
// ===================== TSUNDERE LINES =====================
const TSUN_COMMENTS = {
  onLoad: [
    "...you came back. Whatever. I prepared the covers anyway.",
    "I wasn't waiting for you. The covers were just already loaded.",
    "Don't assume I'm happy you searched for this.",
    "I pulled these up for archival purposes. That's all.",
    "You have good taste. Not that I'd ever say that out loud."
  ],
  onSearch: [
    "Fine, I'll look it up. Not because you asked.",
    "I already knew you'd search for this.",
    "...decent choice. I guess.",
    "Fetching. Don't stare at me while I work.",
    "I-I'm not doing this because I like you, okay? It's just efficient."
  ],
  onCoversLoaded: [
    "There. Every cover. You're welcome. Not that you said thanks.",
    "I found them all. It's not like I tried extra hard or anything.",
    "Don't think this means anything. I just have a thorough archive.",
    "All covers retrieved. You owe me nothing. I don't want anything from you.",
    "Here are your covers. Stop looking at me like that."
  ],
  onSelect: [
    "Picking covers? What are you making... not that I care.",
    "Choose wisely. Not that your taste is ever wrong. Well. Sometimes.",
    "Fine. Build your little grid. I won't stop you.",
    "9 selections and you get a grid. I made that feature for no one in particular."
  ],
  onDownload: [
    "You saved it. Good. I'm not glad or anything.",
    "Downloaded. Don't tell anyone I helped you.",
    "It came out nice. N-not that I put effort in.",
    "There. Take it and go. And... come back sometime. To use the archive. Obviously."
  ]
};

function tsunLine(category) {
  const lines = TSUN_COMMENTS[category];
  return lines[Math.floor(Math.random() * lines.length)];
}

const GENRE_TSUN = {
  'Action': "...fine. explosions.",
  'Romance': "d-don't look at me reading these",
  'Fantasy': "i like the world-building. that's all.",
  'Horror': "i'm not scared. you're scared.",
  'Comedy': "i didn't laugh. my face just did that."
};

// ===================== STATE =====================
const state = {
  theme: 'dark',
  searchResults: [],
  currentManga: null,
  covers: [],
  displayedCovers: [],
  perPage: 30,
  page: 0,
  totalCovers: 0,
  selectedCovers: new Set(),
  selectMode: false,
  lightboxIndex: 0,
  touchStartX: 0,
  touchStartY: 0,
  genres: ['Action', 'Romance', 'Fantasy', 'Horror', 'Comedy'],
  searchTimeout: null,
  acIndex: -1
};

// ===================== DOM REFS =====================
const $ = id => document.getElementById(id);
const themeToggle = $('themeToggle');
const searchInput = $('searchInput');
const acDropdown = $('autocompleteDropdown');
const mangaMeta = $('mangaMeta');
const gallerySection = $('gallerySection');
const galleryLoading = $('galleryLoading');
const loadingCaption = $('loadingCaption');
const coversGrid = $('coversGrid');
const galleryLabel = $('galleryLabel');
const loadMoreWrap = $('loadMoreWrap');
const loadMoreBtn = $('loadMoreBtn');
const emptyState = $('emptyState');
const selectionToolbar = $('selectionToolbar');
const toolbarCount = $('toolbarCount');
const buildGridBtn = $('buildGridBtn');
const clearSelectionBtn = $('clearSelectionBtn');
const lightbox = $('lightbox');
const lightboxImg = $('lightboxImg');
const lightboxInfo = $('lightboxInfo');
const lightboxClose = $('lightboxClose');
const lightboxPrev = $('lightboxPrev');
const lightboxNext = $('lightboxNext');
const gridModal = $('gridModal');
const gridCanvas = $('gridCanvas');
const downloadGrid = $('downloadGrid');
const closeModal = $('closeModal');
const selectModeBtn = $('selectModeBtn');
const selectionCountLabel = $('selectionCountLabel');
const genreBlocks = $('genreBlocks');

// ===================== THEME =====================
themeToggle.addEventListener('click', () => {
  state.theme = state.theme === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', state.theme);
  themeToggle.textContent = state.theme === 'dark' ? 'Too bright' : 'Too dark';
  showNotif(state.theme === 'light' ? "Fine. Light mode. If that's what you want." : "Back to dark. Better. Not that I care about your eyes.", 'blush');
});

// ===================== SEARCH / AUTOCOMPLETE =====================
searchInput.addEventListener('input', () => {
  clearTimeout(state.searchTimeout);
  const q = searchInput.value.trim();
  if (q.length < 2) { closeDropdown(); return; }
  state.searchTimeout = setTimeout(() => fetchSuggestions(q), 380);
});

searchInput.addEventListener('keydown', e => {
  const items = acDropdown.querySelectorAll('.autocomplete-item');
  if (e.key === 'ArrowDown') { state.acIndex = Math.min(state.acIndex + 1, items.length - 1); highlightAC(items); e.preventDefault(); }
  else if (e.key === 'ArrowUp') { state.acIndex = Math.max(state.acIndex - 1, -1); highlightAC(items); e.preventDefault(); }
  else if (e.key === 'Enter') {
    if (state.acIndex >= 0 && items[state.acIndex]) items[state.acIndex].click();
    else if (searchInput.value.trim()) fetchSuggestions(searchInput.value.trim(), true);
    e.preventDefault();
  }
  else if (e.key === 'Escape') closeDropdown();
});

function highlightAC(items) {
  items.forEach((el, i) => el.classList.toggle('active', i === state.acIndex));
}

document.addEventListener('click', e => {
  if (!e.target.closest('.search-wrap')) closeDropdown();
});

async function fetchSuggestions(query, autoSelect = false) {
  try {
    const url = `https://api.jikan.moe/v4/manga?q=${encodeURIComponent(query)}&limit=8&sfw=false`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Jikan error');
    const data = await res.json();
    if (!data.data) return;
    state.searchResults = data.data;
    if (autoSelect && data.data.length > 0) { selectManga(data.data[0]); return; }
    renderDropdown(data.data);
  } catch(e) {
    console.error('Search failed:', e);
    showNotif("Search stumbled. Try again. Not that I'm flustered or anything.", 'blush');
  }
}

function renderDropdown(results) {
  if (!results.length) { closeDropdown(); return; }
  acDropdown.innerHTML = results.map((m, i) => `
    <div class="autocomplete-item" data-idx="${i}">
      <img class="autocomplete-thumb"
        src="${m.images?.jpg?.small_image_url || ''}"
        alt=""
        loading="lazy"
        onerror="this.style.background='var(--surface2)'">
      <div class="autocomplete-info">
        <span class="name">${escHtml(m.title)}</span>
        <span class="meta">${m.type || 'Manga'} &middot; ${m.status || 'Unknown'} &middot; ${m.score ? m.score + ' score' : 'Not rated'}</span>
      </div>
    </div>
  `).join('');
  acDropdown.classList.add('open');
  state.acIndex = -1;
  acDropdown.querySelectorAll('.autocomplete-item').forEach((el, i) => {
    el.addEventListener('click', () => selectManga(results[i]));
  });
}

function closeDropdown() {
  acDropdown.classList.remove('open');
  acDropdown.innerHTML = '';
  state.acIndex = -1;
}

function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ===================== SELECT MANGA =====================
async function selectManga(manga) {
  closeDropdown();
  searchInput.value = manga.title;

  state.currentManga = manga;
  state.covers = [];
  state.displayedCovers = [];
  state.page = 0;
  state.selectedCovers.clear();
  state.selectMode = false;
  selectModeBtn.textContent = 'Pick covers, I suppose';
  updateSelectionUI();

  renderMeta(manga);
  showNotif(tsunLine('onSearch'), 'blush');
  await fetchCovers(manga);
}

const TSUN_META_COMMENTS = [
  "...don't you dare say it looks good because I noticed it first.",
  "I've read this. Not saying I recommend it. I'm just saying.",
  "You picked this one. Interesting. I mean — whatever.",
  "I didn't bookmark this. It just happened to be open on my screen.",
  "Fine taste. Not that I'm impressed."
];

function renderMeta(m) {
  $('metaCoverImg').src = m.images?.jpg?.large_image_url || m.images?.jpg?.image_url || '';
  $('metaTitle').textContent = m.title;

  const tags = [
    ...(m.genres || []).slice(0, 3).map(g => `<span class="tag">${escHtml(g.name)}</span>`),
    m.status ? `<span class="tag accent">${escHtml(m.status)}</span>` : '',
    m.type   ? `<span class="tag">${escHtml(m.type)}</span>` : '',
    m.score  ? `<span class="tag">Score ${m.score}</span>` : ''
  ].filter(Boolean).join('');

  $('metaTags').innerHTML = tags;
  $('metaSynopsis').textContent = m.synopsis || 'No synopsis available. I would have written a better one.';
  $('metaTsunComment').textContent = TSUN_META_COMMENTS[Math.floor(Math.random() * TSUN_META_COMMENTS.length)];
  mangaMeta.classList.add('visible');
}

// ===================== FETCH COVERS =====================
async function fetchCovers(manga) {
  gallerySection.classList.remove('visible');
  emptyState.classList.remove('visible');
  coversGrid.innerHTML = '';
  loadMoreWrap.style.display = 'none';
  galleryLoading.classList.add('visible');
  loadingCaption.classList.add('visible');

  // Step 1: Search MangaDex for the manga by title
  let mdMangaId = null;
  try {
    const mdSearchUrl = `https://api.mangadex.org/manga?title=${encodeURIComponent(manga.title)}&limit=10&contentRating[]=safe&contentRating[]=suggestive&contentRating[]=erotica&contentRating[]=pornographic&includes[]=cover_art&order[relevance]=desc`;
    const searchRes = await fetch(mdSearchUrl);
    if (searchRes.ok) {
      const searchData = await searchRes.json();
      if (searchData.data && searchData.data.length > 0) {
        // Try to find best match: title matches closely
        const titleLower = manga.title.toLowerCase();
        let best = searchData.data[0];
        for (const m of searchData.data) {
          const attrs = m.attributes;
          const titles = [
            attrs.title?.en,
            attrs.title?.ja,
            attrs.title?.['ja-ro'],
            ...(attrs.altTitles || []).flatMap(t => Object.values(t))
          ].filter(Boolean).map(t => t.toLowerCase());
          if (titles.some(t => t === titleLower || t.includes(titleLower) || titleLower.includes(t))) {
            best = m;
            break;
          }
        }
        mdMangaId = best.id;
      }
    }
  } catch(e) {
    console.warn('MangaDex search failed:', e);
  }

  if (mdMangaId) {
    // Step 2: Fetch all covers from MangaDex
    let allCovers = [];
    let offset = 0;
    const limit = 100;
    try {
      while (true) {
        const covUrl = `https://api.mangadex.org/cover?manga[]=${mdMangaId}&limit=${limit}&offset=${offset}&order[volume]=asc`;
        const covRes = await fetch(covUrl);
        if (!covRes.ok) break;
        const covData = await covRes.json();
        if (!covData.data || covData.data.length === 0) break;
        allCovers = allCovers.concat(covData.data);
        if (covData.data.length < limit) break;
        offset += limit;
      }
    } catch(e) {
      console.warn('MangaDex covers fetch failed:', e);
    }

    if (allCovers.length > 0) {
      state.covers = allCovers.map(c => ({
        url: `https://uploads.mangadex.org/covers/${mdMangaId}/${c.attributes.fileName}.512.jpg`,
        fullUrl: `https://uploads.mangadex.org/covers/${mdMangaId}/${c.attributes.fileName}`,
        volume: c.attributes.volume ? `Vol. ${c.attributes.volume}` : '',
        locale: c.attributes.locale || ''
      }));
      finishLoadingCovers();
      return;
    }
  }

  // Step 3: Fallback to Jikan pictures endpoint
  console.log('Falling back to Jikan pictures for:', manga.title);
  try {
    const picRes = await fetch(`https://api.jikan.moe/v4/manga/${manga.mal_id}/pictures`);
    if (picRes.ok) {
      const picData = await picRes.json();
      if (picData.data && picData.data.length > 0) {
        state.covers = picData.data.map((p, i) => ({
          url: p.jpg?.large_image_url || p.jpg?.image_url || '',
          fullUrl: p.jpg?.large_image_url || '',
          volume: `Cover ${i + 1}`,
          locale: ''
        })).filter(c => c.url);
        if (state.covers.length > 0) { finishLoadingCovers(); return; }
      }
    }
  } catch(e) {
    console.warn('Jikan pictures fallback failed:', e);
  }

  // Nothing found
  galleryLoading.classList.remove('visible');
  loadingCaption.classList.remove('visible');
  emptyState.classList.add('visible');
  showNotif("I looked everywhere. Nothing. It's not my fault.", 'blush');
}

function finishLoadingCovers() {
  state.totalCovers = state.covers.length;
  galleryLoading.classList.remove('visible');
  loadingCaption.classList.remove('visible');
  gallerySection.classList.add('visible');
  galleryLabel.innerHTML = `&#x2014; <span>${state.totalCovers}</span> covers collected. you're welcome.`;
  renderNextPage();
  showNotif(tsunLine('onCoversLoaded'), 'blush');
}

// ===================== RENDER COVERS =====================
const BLANK_SVG = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='210'%3E%3Crect fill='%23222' width='140' height='210'/%3E%3C/svg%3E`;

function renderNextPage() {
  const start = state.page * state.perPage;
  const end = Math.min(start + state.perPage, state.covers.length);
  const slice = state.covers.slice(start, end);

  slice.forEach((cover, idx) => {
    const absIdx = start + idx;
    const card = document.createElement('div');
    card.className = 'cover-card';
    card.dataset.idx = absIdx;
    card.style.animationDelay = `${(idx % state.perPage) * 18}ms`;
    card.innerHTML = `
      <div class="cover-select-badge">&#x2714;</div>
      <img src="${cover.url}" alt="${escHtml(cover.volume)}" loading="lazy" onerror="this.src='${BLANK_SVG}'">
      ${cover.volume ? `<div class="cover-vol">${escHtml(cover.volume)}</div>` : ''}
    `;
    card.addEventListener('click', () => {
      if (state.selectMode) toggleSelectCover(card, absIdx);
      else openLightbox(absIdx);
    });
    coversGrid.appendChild(card);
    state.displayedCovers.push(cover);
  });

  state.page++;
  loadMoreWrap.style.display = end < state.covers.length ? 'block' : 'none';
}

loadMoreBtn.addEventListener('click', renderNextPage);

// ===================== SELECT MODE =====================
selectModeBtn.addEventListener('click', () => {
  state.selectMode = !state.selectMode;
  selectModeBtn.textContent = state.selectMode ? 'Stop picking, I guess' : 'Pick covers, I suppose';
  if (!state.selectMode) {
    state.selectedCovers.clear();
    updateSelectionUI();
    coversGrid.querySelectorAll('.cover-card').forEach(c => c.classList.remove('selected'));
  } else {
    showNotif(tsunLine('onSelect'), 'blush');
  }
});

function toggleSelectCover(card, idx) {
  if (state.selectedCovers.has(idx)) {
    state.selectedCovers.delete(idx);
    card.classList.remove('selected');
  } else {
    if (state.selectedCovers.size >= 9) {
      showNotif("9 is the limit. I don't make the rules. Actually I do. Still no.", 'blush');
      return;
    }
    state.selectedCovers.add(idx);
    card.classList.add('selected');
  }
  updateSelectionUI();
}

function updateSelectionUI() {
  const count = state.selectedCovers.size;
  toolbarCount.textContent = count;
  buildGridBtn.disabled = count !== 9;

  if (count > 0) {
    selectionToolbar.classList.add('visible');
    selectionCountLabel.style.display = 'inline';
    selectionCountLabel.textContent = `${count} selected`;
  } else {
    selectionToolbar.classList.remove('visible');
    selectionCountLabel.style.display = 'none';
  }

  const cells = document.querySelectorAll('.grid-preview-cell');
  cells.forEach((cell, i) => cell.classList.toggle('filled', i < count));
}

clearSelectionBtn.addEventListener('click', () => {
  state.selectedCovers.clear();
  coversGrid.querySelectorAll('.cover-card').forEach(c => c.classList.remove('selected'));
  updateSelectionUI();
  showNotif("Everything cleared. Fresh start. Not that I mind doing this for you.", 'blush');
});

// ===================== LIGHTBOX =====================
function openLightbox(idx) {
  state.lightboxIndex = idx;
  const cover = state.covers[idx];
  if (!cover) return;
  lightboxImg.src = cover.url;
  lightboxInfo.textContent = cover.volume || '';
  lightbox.classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeLightbox() {
  lightbox.classList.remove('open');
  document.body.style.overflow = '';
}

function lightboxGo(dir) {
  const newIdx = state.lightboxIndex + dir;
  if (newIdx < 0 || newIdx >= state.covers.length) return;
  state.lightboxIndex = newIdx;
  lightboxImg.style.opacity = '0';
  lightboxImg.style.transform = `translateX(${dir > 0 ? 20 : -20}px)`;
  setTimeout(() => {
    lightboxImg.src = state.covers[newIdx].url;
    lightboxInfo.textContent = state.covers[newIdx].volume || '';
    lightboxImg.style.transition = 'opacity 0.2s, transform 0.2s';
    lightboxImg.style.opacity = '1';
    lightboxImg.style.transform = 'translateX(0)';
  }, 80);
}

lightboxClose.addEventListener('click', closeLightbox);
lightboxPrev.addEventListener('click', () => lightboxGo(-1));
lightboxNext.addEventListener('click', () => lightboxGo(1));
lightbox.addEventListener('click', e => { if (e.target === lightbox) closeLightbox(); });

document.addEventListener('keydown', e => {
  if (!lightbox.classList.contains('open')) return;
  if (e.key === 'ArrowLeft') lightboxGo(-1);
  if (e.key === 'ArrowRight') lightboxGo(1);
  if (e.key === 'Escape') closeLightbox();
});

lightboxImg.addEventListener('touchstart', e => {
  state.touchStartX = e.touches[0].clientX;
  state.touchStartY = e.touches[0].clientY;
}, { passive: true });

lightboxImg.addEventListener('touchend', e => {
  const dx = e.changedTouches[0].clientX - state.touchStartX;
  const dy = e.changedTouches[0].clientY - state.touchStartY;
  if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 50) lightboxGo(dx < 0 ? 1 : -1);
}, { passive: true });

// ===================== 3x3 GRID BUILDER =====================
buildGridBtn.addEventListener('click', async () => {
  if (state.selectedCovers.size !== 9) return;
  const indices = Array.from(state.selectedCovers).sort((a, b) => a - b);
  const urls = indices.map(i => state.covers[i].url);

  gridModal.classList.add('open');
  document.body.style.overflow = 'hidden';

  const cellSize = 200;
  const gap = 4;
  const canvasW = cellSize * 3 + gap * 2;
  const canvasH = cellSize * 1.5 * 3 + gap * 2;
  gridCanvas.width = canvasW;
  gridCanvas.height = canvasH;
  const ctx = gridCanvas.getContext('2d');
  ctx.fillStyle = '#0a0a0a';
  ctx.fillRect(0, 0, canvasW, canvasH);

  // Placeholder tiles
  for (let i = 0; i < 9; i++) {
    const col = i % 3, row = Math.floor(i / 3);
    ctx.fillStyle = '#1a1a1a';
    ctx.fillRect(col * (cellSize + gap), row * (cellSize * 1.5 + gap), cellSize, cellSize * 1.5);
  }

  const imagePromises = urls.map(url => new Promise(resolve => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => resolve(img);
    img.onerror = () => {
      const img2 = new Image();
      img2.onload = () => resolve(img2);
      img2.onerror = () => resolve(null);
      img2.src = url;
    };
    img.src = url;
  }));

  const images = await Promise.all(imagePromises);

  ctx.fillStyle = '#0a0a0a';
  ctx.fillRect(0, 0, canvasW, canvasH);

  images.forEach((img, i) => {
    const col = i % 3, row = Math.floor(i / 3);
    const x = col * (cellSize + gap);
    const y = row * (cellSize * 1.5 + gap);
    const w = cellSize, h = cellSize * 1.5;

    if (img) {
      const srcAR = img.naturalWidth / img.naturalHeight;
      const dstAR = w / h;
      let sx, sy, sw, sh;
      if (srcAR > dstAR) {
        sh = img.naturalHeight; sw = sh * dstAR;
        sx = (img.naturalWidth - sw) / 2; sy = 0;
      } else {
        sw = img.naturalWidth; sh = sw / dstAR;
        sx = 0; sy = (img.naturalHeight - sh) / 2;
      }
      ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
    } else {
      ctx.fillStyle = '#1a1a1a';
      ctx.fillRect(x, y, w, h);
      ctx.fillStyle = '#555';
      ctx.font = '11px monospace';
      ctx.textAlign = 'center';
      ctx.fillText('cover unavailable', x + w / 2, y + h / 2);
    }
  });

  // Grid lines
  ctx.strokeStyle = 'rgba(0,0,0,0.9)';
  ctx.lineWidth = gap;
  for (let i = 1; i < 3; i++) {
    const xLine = i * (cellSize + gap) - gap / 2;
    ctx.beginPath(); ctx.moveTo(xLine, 0); ctx.lineTo(xLine, canvasH); ctx.stroke();
    const yLine = i * (cellSize * 1.5 + gap) - gap / 2;
    ctx.beginPath(); ctx.moveTo(0, yLine); ctx.lineTo(canvasW, yLine); ctx.stroke();
  }
});

downloadGrid.addEventListener('click', () => {
  try {
    const link = document.createElement('a');
    link.download = `${state.currentManga?.title || 'manga'}-tsun-3x3.png`;
    link.href = gridCanvas.toDataURL('image/png');
    link.click();
    showNotif(tsunLine('onDownload'), 'blush');
  } catch(e) {
    showNotif("Download failed. Right-click the grid to save it manually. Don't make this weird.", 'blush');
  }
});

closeModal.addEventListener('click', () => { gridModal.classList.remove('open'); document.body.style.overflow = ''; });
gridModal.addEventListener('click', e => { if (e.target === gridModal) { gridModal.classList.remove('open'); document.body.style.overflow = ''; }});

// ===================== GENRE CAROUSELS =====================
const GENRE_IDS = { 'Action': 1, 'Romance': 22, 'Fantasy': 10, 'Horror': 14, 'Comedy': 4 };

async function loadGenres() {
  for (const genre of state.genres) {
    await new Promise(r => setTimeout(r, 350)); // stagger to respect rate limits
    const block = document.createElement('div');
    block.className = 'genre-block';
    block.id = `genre-${genre}`;
    block.innerHTML = `
      <div class="genre-header">
        <h2 class="genre-title">${genre}<span class="genre-title-sub">${GENRE_TSUN[genre] || ''}</span></h2>
        <div class="genre-nav">
          <button class="genre-nav-btn" data-genre="${genre}" data-dir="-1">&#x2039;</button>
          <button class="genre-nav-btn" data-genre="${genre}" data-dir="1">&#x203A;</button>
        </div>
      </div>
      <div class="genre-carousel-outer">
        <div class="genre-carousel" id="carousel-${genre}">
          ${Array(6).fill(0).map(() => `<div class="genre-card"><div style="width:140px;aspect-ratio:2/3;" class="skeleton"></div></div>`).join('')}
        </div>
      </div>
    `;
    genreBlocks.appendChild(block);
    fetchGenre(genre, GENRE_IDS[genre]);
  }

  genreBlocks.addEventListener('click', e => {
    const btn = e.target.closest('.genre-nav-btn');
    if (!btn) return;
    const carousel = $(`carousel-${btn.dataset.genre}`);
    if (!carousel) return;
    const cardW = 140 + 14;
    const dir = parseInt(btn.dataset.dir);
    const current = carousel._offset || 0;
    const maxScroll = Math.max(0, carousel.children.length * cardW - carousel.parentElement.offsetWidth - 14);
    carousel._offset = Math.max(0, Math.min(maxScroll, current + dir * cardW * 3));
    carousel.style.transform = `translateX(-${carousel._offset}px)`;
  });

  genreBlocks.addEventListener('touchstart', e => {
    const c = e.target.closest('.genre-carousel');
    if (c) c._touchX = e.touches[0].clientX;
  }, { passive: true });

  genreBlocks.addEventListener('touchend', e => {
    const c = e.target.closest('.genre-carousel');
    if (!c || c._touchX == null) return;
    const dx = e.changedTouches[0].clientX - c._touchX;
    if (Math.abs(dx) < 40) return;
    const cardW = 140 + 14;
    const current = c._offset || 0;
    const maxScroll = Math.max(0, c.children.length * cardW - c.parentElement.offsetWidth - 14);
    c._offset = Math.max(0, Math.min(maxScroll, current + (dx < 0 ? cardW * 2 : -cardW * 2)));
    c.style.transform = `translateX(-${c._offset}px)`;
  }, { passive: true });
}

async function fetchGenre(genre, genreId) {
  try {
    const url = `https://api.jikan.moe/v4/manga?genres=${genreId}&order_by=popularity&sort=asc&limit=15&type=manga&sfw=false`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (!data.data || !data.data.length) return;

    const carousel = $(`carousel-${genre}`);
    if (!carousel) return;

    carousel.innerHTML = data.data.map(m => `
      <div class="genre-card" data-mal="${m.mal_id}">
        <img
          src="${m.images?.jpg?.image_url || ''}"
          alt="${escHtml(m.title)}"
          loading="lazy"
          onerror="this.src='${BLANK_SVG}'">
        <div class="genre-card-title">${escHtml(m.title)}</div>
        <div class="genre-card-score">
          <span class="star">&#x25B2;</span> ${m.score || 'N/A'}
          <span style="margin-left:4px;color:var(--border)">|</span>
          ${m.volumes ? m.volumes + ' vol' : m.chapters ? m.chapters + ' ch' : '?'}
        </div>
      </div>
    `).join('');

    carousel.querySelectorAll('.genre-card').forEach((card, i) => {
      card.addEventListener('click', () => {
        const manga = data.data[i];
        searchInput.value = manga.title;
        window.scrollTo({ top: 0, behavior: 'smooth' });
        setTimeout(() => selectManga(manga), 400);
      });
    });

  } catch(e) {
    console.warn(`Genre "${genre}" failed:`, e);
    const carousel = $(`carousel-${genre}`);
    if (carousel) carousel.innerHTML = `<p style="color:var(--muted);font-size:11px;padding:1rem;font-style:italic;">couldn't load these. not my fault.</p>`;
  }
}

// ===================== NOTIFICATIONS =====================
function showNotif(msg, type = '') {
  const el = document.createElement('div');
  el.className = `notif${type ? ' ' + type : ''}`;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3200);
}

// ===================== INIT =====================
loadGenres();
showNotif(tsunLine('onLoad'), 'blush');
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tsun — It's not like I archived these for you</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0a;
    --surface: #111111;
    --surface2: #1a1a1a;
    --border: #2a2a2a;
    --text: #e8e4dc;
    --muted: #6b6560;
    --accent: #c9a96e;
    --accent2: #8b5e3c;
    --danger: #9b4040;
    --blush: #c97070;
    --card-shadow: 0 4px 24px rgba(0,0,0,0.6);
    --radius: 3px;
    --transition: 0.2s cubic-bezier(0.4,0,0.2,1);
  }
  [data-theme="light"] {
    --bg: #f5f0e8;
    --surface: #ede8df;
    --surface2: #e5dfd4;
    --border: #cfc8bc;
    --text: #1a1714;
    --muted: #8a8278;
    --accent: #8b5e2c;
    --accent2: #c9a96e;
    --danger: #9b4040;
    --blush: #c97070;
    --card-shadow: 0 4px 24px rgba(0,0,0,0.15);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { scroll-behavior: smooth; }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 13px;
    line-height: 1.6;
    transition: background var(--transition), color var(--transition);
  }

  /* HEADER */
  header {
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 1px solid var(--border);
    padding: 0 2rem;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    backdrop-filter: blur(12px);
    background: color-mix(in srgb, var(--bg) 90%, transparent);
  }

  .logo {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.8rem;
    font-weight: 300;
    letter-spacing: 0.15em;
    color: var(--accent);
    text-decoration: none;
    display: flex;
    align-items: baseline;
    gap: 2px;
  }
  .logo span { color: var(--text); font-style: italic; }
  .logo-blush {
    font-size: 10px;
    letter-spacing: 0.08em;
    color: var(--blush);
    font-family: 'DM Mono', monospace;
    font-style: normal;
    opacity: 0.7;
    margin-left: 6px;
    align-self: center;
  }

  .header-right { display: flex; align-items: center; gap: 1rem; }

  .header-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    cursor: pointer;
    padding: 6px 12px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.1em;
    transition: all var(--transition);
    text-transform: uppercase;
    text-decoration: none;
    display: inline-block;
  }
  .header-btn:hover { border-color: var(--accent); color: var(--accent); }
  .header-btn.primary { 
    background: var(--accent); 
    color: var(--bg); 
    border-color: var(--accent);
  }
  .header-btn.primary:hover { 
    background: var(--accent2); 
    border-color: var(--accent2);
  }

  .user-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 12px;
    border: 1px solid var(--border);
    font-size: 11px;
    color: var(--text);
  }
  .user-badge img {
    width: 20px;
    height: 20px;
    border-radius: 50%;
  }

  /* HERO */
  .hero {
    padding: 5rem 2rem 3rem;
    max-width: 900px;
    margin: 0 auto;
    text-align: center;
  }

  .hero-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(2.5rem, 6vw, 5rem);
    font-weight: 300;
    line-height: 1;
    letter-spacing: -0.02em;
    margin-bottom: 0.5rem;
  }
  .hero-title em { font-style: italic; color: var(--accent); }

  .hero-sub {
    color: var(--muted);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    font-size: 11px;
    margin-bottom: 2.5rem;
  }

  .hero-disclaimer {
    color: var(--blush);
    font-size: 10px;
    letter-spacing: 0.1em;
    margin-top: -1.8rem;
    margin-bottom: 2rem;
    opacity: 0.8;
    font-style: italic;
  }

  .search-wrap {
    position: relative;
    max-width: 560px;
    margin: 0 auto;
  }

  .search-input {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 14px;
    padding: 14px 50px 14px 20px;
    outline: none;
    transition: border-color var(--transition);
    letter-spacing: 0.05em;
  }
  .search-input::placeholder { color: var(--muted); }
  .search-input:focus { border-color: var(--accent); }

  .search-icon {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    pointer-events: none;
    font-size: 16px;
  }

  .autocomplete-dropdown {
    position: absolute;
    top: calc(100% + 4px);
    left: 0; right: 0;
    background: var(--surface);
    border: 1px solid var(--border);
    z-index: 200;
    max-height: 320px;
    overflow-y: auto;
    display: none;
  }
  .autocomplete-dropdown.open { display: block; }

  .autocomplete-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 16px;
    cursor: pointer;
    transition: background var(--transition);
    border-bottom: 1px solid var(--border);
  }
  .autocomplete-item:last-child { border-bottom: none; }
  .autocomplete-item:hover, .autocomplete-item.active { background: var(--surface2); }

  .autocomplete-thumb {
    width: 32px;
    height: 44px;
    object-fit: cover;
    flex-shrink: 0;
    background: var(--surface2);
  }

  .autocomplete-info .name { color: var(--text); font-size: 13px; display: block; }
  .autocomplete-info .meta { color: var(--muted); font-size: 11px; letter-spacing: 0.05em; }

  /* COLOR FILTER */
  .color-filter {
    max-width: 560px;
    margin: 1.5rem auto 0;
    padding: 1rem;
    background: var(--surface);
    border: 1px solid var(--border);
  }

  .color-filter-label {
    font-size: 10px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 0.8rem;
    display: block;
  }

  .color-swatches {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .color-swatch {
    width: 40px;
    height: 40px;
    border: 2px solid var(--border);
    cursor: pointer;
    transition: all var(--transition);
    position: relative;
  }
  .color-swatch:hover {
    transform: scale(1.1);
    border-color: var(--accent);
  }
  .color-swatch.active {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px var(--accent);
  }
  .color-swatch.active::after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 18px;
    text-shadow: 0 0 3px rgba(0,0,0,0.8);
  }

  /* GENRE BLOCKS */
  .genre-blocks {
    max-width: 1400px;
    margin: 4rem auto;
    padding: 0 2rem;
  }

  .genre-block {
    margin-bottom: 3rem;
  }

  .genre-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 1rem;
  }

  .genre-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.8rem;
    font-weight: 300;
    letter-spacing: 0.08em;
  }
  .genre-title-sub {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.1em;
    color: var(--blush);
    margin-left: 12px;
    font-style: italic;
    opacity: 0.7;
  }

  .genre-nav {
    display: flex;
    gap: 6px;
  }

  .genre-nav-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    cursor: pointer;
    width: 32px;
    height: 32px;
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition);
    line-height: 1;
  }
  .genre-nav-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .genre-carousel-outer {
    overflow: hidden;
    position: relative;
  }

  .genre-carousel {
    display: flex;
    gap: 14px;
    transition: transform 0.4s cubic-bezier(0.4,0,0.2,1);
  }

  .genre-card {
    flex: 0 0 140px;
    cursor: pointer;
    transition: transform var(--transition);
  }
  .genre-card:hover {
    transform: translateY(-4px);
  }

  .genre-card img {
    width: 140px;
    aspect-ratio: 2/3;
    object-fit: cover;
    display: block;
    box-shadow: var(--card-shadow);
    margin-bottom: 8px;
  }

  .genre-card-title {
    font-size: 11px;
    line-height: 1.3;
    margin-bottom: 4px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .genre-card-score {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 0.05em;
  }
  .genre-card-score .star {
    color: var(--accent);
  }

  /* SKELETON */
  .skeleton {
    background: linear-gradient(90deg, var(--surface2) 25%, var(--border) 50%, var(--surface2) 75%);
    background-size: 200% 100%;
    animation: skeleton 1.5s ease-in-out infinite;
  }
  @keyframes skeleton {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* NOTIF */
  .notif {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 12px 20px;
    font-size: 11px;
    letter-spacing: 0.08em;
    box-shadow: var(--card-shadow);
    z-index: 1000;
    animation: slideIn 0.3s ease;
    max-width: 320px;
  }
  .notif.blush { border-color: var(--blush); color: var(--blush); }
  @keyframes slideIn {
    from { transform: translateY(100px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  /* LOGIN MODAL */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(4px);
    z-index: 500;
    display: none;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.open { display: flex; }

  .modal-content {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 2rem;
    max-width: 400px;
    width: 90%;
    box-shadow: var(--card-shadow);
    position: relative;
  }

  .modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    color: var(--muted);
    font-size: 24px;
    cursor: pointer;
    line-height: 1;
    transition: color var(--transition);
  }
  .modal-close:hover { color: var(--text); }

  .modal-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.8rem;
    font-weight: 300;
    margin-bottom: 1rem;
  }

  .modal-text {
    color: var(--muted);
    font-size: 12px;
    line-height: 1.6;
    margin-bottom: 1.5rem;
  }

  .google-btn {
    width: 100%;
    padding: 12px;
    background: white;
    color: #1a1a1a;
    border: 1px solid var(--border);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all var(--transition);
  }
  .google-btn:hover {
    background: #f5f5f5;
    transform: translateY(-2px);
    box-shadow: var(--card-shadow);
  }
  .google-btn img {
    width: 20px;
    height: 20px;
  }

  @media (max-width: 768px) {
    header { padding: 0 1rem; }
    .hero { padding: 3rem 1rem 2rem; }
    .genre-blocks { padding: 0 1rem; }
    .genre-carousel { gap: 10px; }
    .genre-card { flex: 0 0 110px; }
    .genre-card img { width: 110px; }
    .notif { right: 1rem; bottom: 1rem; }
  }
</style>
</head>
<body>

<header>
  <a href="/" class="logo">Tsun<span>dere</span><span class="logo-blush">hmpf.</span></a>
  <div class="header-right">
    <a href="builder.html" class="header-btn primary">Create 3×3</a>
    <button class="header-btn" id="loginBtn">Login</button>
    <button class="header-btn" id="themeToggle">Dark</button>
    <div class="user-badge" id="userBadge" style="display: none;">
      <img src="" alt="" id="userAvatar">
      <span id="userName"></span>
    </div>
  </div>
</header>

<div class="hero">
  <h1 class="hero-title">It's not like I <em>archived</em><br>these for you</h1>
  <p class="hero-sub">Your personal manga archive</p>
  <p class="hero-disclaimer">b-baka! i just had extra server space...</p>
  
  <div class="search-wrap">
    <input type="text" class="search-input" id="searchInput" placeholder="search manga... if you want">
    <span class="search-icon">⌕</span>
    <div class="autocomplete-dropdown" id="autocomplete"></div>
  </div>

  <div class="color-filter">
    <label class="color-filter-label">Filter by cover color (because you're picky)</label>
    <div class="color-swatches">
      <div class="color-swatch" data-color="all" style="background: linear-gradient(135deg, #c9a96e 0%, #c97070 100%);"></div>
      <div class="color-swatch" data-color="red" style="background: #e74c3c;"></div>
      <div class="color-swatch" data-color="blue" style="background: #3498db;"></div>
      <div class="color-swatch" data-color="green" style="background: #2ecc71;"></div>
      <div class="color-swatch" data-color="yellow" style="background: #f39c12;"></div>
      <div class="color-swatch" data-color="purple" style="background: #9b59b6;"></div>
      <div class="color-swatch" data-color="pink" style="background: #e91e63;"></div>
      <div class="color-swatch" data-color="orange" style="background: #ff5722;"></div>
      <div class="color-swatch" data-color="brown" style="background: #8b5e3c;"></div>
      <div class="color-swatch" data-color="gray" style="background: #95a5a6;"></div>
      <div class="color-swatch" data-color="black" style="background: #2c3e50;"></div>
      <div class="color-swatch" data-color="white" style="background: #ecf0f1;"></div>
    </div>
  </div>
</div>

<div class="genre-blocks" id="genreBlocks"></div>

<!-- Login Modal -->
<div class="modal-overlay" id="loginModal">
  <div class="modal-content">
    <button class="modal-close" id="closeLoginModal">×</button>
    <h2 class="modal-title">Login</h2>
    <p class="modal-text">Sign in with Google to save your 3×3 grids. Not that I care what you do with them...</p>
    <button class="google-btn" id="googleLoginBtn">
      <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Sign in with Google
    </button>
  </div>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
const $ = id => document.getElementById(id);
const BLANK_SVG = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg"%3E%3C/svg%3E';

// Google OAuth Config - REPLACE WITH YOUR CLIENT ID
const GOOGLE_CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com';

// Auth state
let currentUser = null;

// Check for saved user
const savedUser = localStorage.getItem('tsun_user');
if (savedUser) {
  currentUser = JSON.parse(savedUser);
  updateUserUI();
}

function updateUserUI() {
  if (currentUser) {
    $('loginBtn').style.display = 'none';
    $('userBadge').style.display = 'flex';
    $('userAvatar').src = currentUser.picture;
    $('userName').textContent = currentUser.name.split(' ')[0];
  } else {
    $('loginBtn').style.display = 'inline-block';
    $('userBadge').style.display = 'none';
  }
}

// Google Sign-In
function handleCredentialResponse(response) {
  const payload = JSON.parseFromString(atob(response.credential.split('.')[1]));
  currentUser = {
    id: payload.sub,
    email: payload.email,
    name: payload.name,
    picture: payload.picture
  };
  localStorage.setItem('tsun_user', JSON.stringify(currentUser));
  updateUserUI();
  $('loginModal').classList.remove('open');
  showNotif("Fine, you're logged in. Don't expect special treatment.", 'blush');
}

window.addEventListener('load', () => {
  if (window.google) {
    google.accounts.id.initialize({
      client_id: GOOGLE_CLIENT_ID,
      callback: handleCredentialResponse
    });
  }
});

$('loginBtn').addEventListener('click', () => {
  if (!currentUser) {
    $('loginModal').classList.add('open');
  }
});

$('googleLoginBtn').addEventListener('click', () => {
  if (window.google) {
    google.accounts.id.prompt();
  } else {
    showNotif("Google SDK not loaded. Check your connection, genius.", 'blush');
  }
});

$('closeLoginModal').addEventListener('click', () => {
  $('loginModal').classList.remove('open');
});

$('loginModal').addEventListener('click', e => {
  if (e.target === $('loginModal')) {
    $('loginModal').classList.remove('open');
  }
});

// Logout
$('userBadge').addEventListener('click', () => {
  if (confirm("Log out? All your grids will be lost... forever. (Just kidding, they're in localStorage)")) {
    currentUser = null;
    localStorage.removeItem('tsun_user');
    updateUserUI();
    showNotif("Whatever. You'll be back.", 'blush');
  }
});

// Theme toggle
const themeToggle = $('themeToggle');
const html = document.documentElement;
const savedTheme = localStorage.getItem('tsun_theme') || 'dark';
html.setAttribute('data-theme', savedTheme);
themeToggle.textContent = savedTheme === 'dark' ? 'Dark' : 'Light';

themeToggle.addEventListener('click', () => {
  const current = html.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  themeToggle.textContent = next === 'dark' ? 'Dark' : 'Light';
  localStorage.setItem('tsun_theme', next);
});

// Search & Autocomplete
const searchInput = $('searchInput');
const autocomplete = $('autocomplete');
let searchTimeout;
let acResults = [];
let acIndex = -1;
let selectedColor = 'all';

searchInput.addEventListener('input', e => {
  clearTimeout(searchTimeout);
  const query = e.target.value.trim();
  if (query.length < 2) {
    autocomplete.classList.remove('open');
    return;
  }
  searchTimeout = setTimeout(() => searchManga(query), 300);
});

async function searchManga(query) {
  try {
    const url = `https://api.jikan.moe/v4/manga?q=${encodeURIComponent(query)}&limit=8&type=manga&sfw=false`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Search failed');
    const data = await res.json();
    acResults = data.data || [];
    renderAutocomplete();
  } catch(e) {
    console.warn('Search error:', e);
  }
}

function renderAutocomplete() {
  if (!acResults.length) {
    autocomplete.classList.remove('open');
    return;
  }
  autocomplete.innerHTML = acResults.map((m, i) => `
    <div class="autocomplete-item${i === acIndex ? ' active' : ''}" data-index="${i}">
      <img class="autocomplete-thumb" src="${m.images?.jpg?.small_image_url || BLANK_SVG}" alt="">
      <div class="autocomplete-info">
        <span class="name">${escHtml(m.title)}</span>
        <span class="meta">${m.type || 'Manga'} · ${m.volumes || '?'} vol</span>
      </div>
    </div>
  `).join('');
  autocomplete.classList.add('open');

  autocomplete.querySelectorAll('.autocomplete-item').forEach(item => {
    item.addEventListener('click', () => {
      const manga = acResults[parseInt(item.dataset.index)];
      window.location.href = `builder.html?add=${manga.mal_id}`;
    });
  });
}

searchInput.addEventListener('keydown', e => {
  if (!autocomplete.classList.contains('open')) return;
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    acIndex = Math.min(acIndex + 1, acResults.length - 1);
    renderAutocomplete();
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    acIndex = Math.max(acIndex - 1, -1);
    renderAutocomplete();
  } else if (e.key === 'Enter' && acIndex >= 0) {
    e.preventDefault();
    const manga = acResults[acIndex];
    window.location.href = `builder.html?add=${manga.mal_id}`;
  } else if (e.key === 'Escape') {
    autocomplete.classList.remove('open');
    acIndex = -1;
  }
});

document.addEventListener('click', e => {
  if (!searchInput.contains(e.target) && !autocomplete.contains(e.target)) {
    autocomplete.classList.remove('open');
  }
});

// Color filter
document.querySelectorAll('.color-swatch').forEach(swatch => {
  swatch.addEventListener('click', () => {
    document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
    swatch.classList.add('active');
    selectedColor = swatch.dataset.color;
    reloadGenres();
    showNotif(selectedColor === 'all' ? "Showing everything. Happy now?" : `Filtered to ${selectedColor}. You're so demanding.`, 'blush');
  });
});

// Activate "all" by default
document.querySelector('[data-color="all"]').classList.add('active');

// Genre carousels
const genreBlocks = $('genreBlocks');
const GENRE_IDS = { 
  'Action': 1, 
  'Romance': 22, 
  'Fantasy': 10, 
  'Horror': 14, 
  'Comedy': 4,
  'Drama': 8,
  'Mystery': 7,
  'Sci-Fi': 24
};
const GENRE_TSUN = {
  'Action': 'not that exciting tbh',
  'Romance': 'so predictable',
  'Fantasy': 'too unrealistic',
  'Horror': "doesn't even scare me",
  'Comedy': "i didn't laugh",
  'Drama': 'too emotional',
  'Mystery': 'saw it coming',
  'Sci-Fi': 'too nerdy'
};

const COLOR_KEYWORDS = {
  red: ['red', 'crimson', 'scarlet', 'blood', 'ruby'],
  blue: ['blue', 'azure', 'ocean', 'sky', 'sapphire'],
  green: ['green', 'emerald', 'forest', 'jade'],
  yellow: ['yellow', 'gold', 'golden', 'amber'],
  purple: ['purple', 'violet', 'amethyst', 'lavender'],
  pink: ['pink', 'rose', 'magenta', 'cherry'],
  orange: ['orange', 'sunset', 'flame'],
  brown: ['brown', 'sepia', 'chocolate'],
  gray: ['gray', 'grey', 'silver', 'steel'],
  black: ['black', 'dark', 'noir', 'shadow'],
  white: ['white', 'snow', 'pearl', 'ivory']
};

let loadedGenres = new Set();

async function loadGenres() {
  genreBlocks.innerHTML = '';
  loadedGenres.clear();
  
  for (const [genre, genreId] of Object.entries(GENRE_IDS)) {
    const block = document.createElement('div');
    block.className = 'genre-block';
    block.id = `genre-${genre}`;
    block.innerHTML = `
      <div class="genre-header">
        <h2 class="genre-title">${genre}<span class="genre-title-sub">${GENRE_TSUN[genre] || ''}</span></h2>
        <div class="genre-nav">
          <button class="genre-nav-btn" data-genre="${genre}" data-dir="-1">‹</button>
          <button class="genre-nav-btn" data-genre="${genre}" data-dir="1">›</button>
        </div>
      </div>
      <div class="genre-carousel-outer">
        <div class="genre-carousel" id="carousel-${genre}">
          ${Array(6).fill(0).map(() => `<div class="genre-card"><div style="width:140px;aspect-ratio:2/3;" class="skeleton"></div></div>`).join('')}
        </div>
      </div>
    `;
    genreBlocks.appendChild(block);
    
    // Stagger API calls to avoid rate limiting (increased delay)
    await new Promise(r => setTimeout(r, 600));
    fetchGenre(genre, genreId);
  }

  // Navigation
  genreBlocks.addEventListener('click', e => {
    const btn = e.target.closest('.genre-nav-btn');
    if (!btn) return;
    const carousel = $(`carousel-${btn.dataset.genre}`);
    if (!carousel) return;
    const cardW = 140 + 14;
    const dir = parseInt(btn.dataset.dir);
    const current = carousel._offset || 0;
    const maxScroll = Math.max(0, carousel.children.length * cardW - carousel.parentElement.offsetWidth - 14);
    carousel._offset = Math.max(0, Math.min(maxScroll, current + dir * cardW * 3));
    carousel.style.transform = `translateX(-${carousel._offset}px)`;
  });
}

async function fetchGenre(genre, genreId, retryCount = 0) {
  try {
    let url = `https://api.jikan.moe/v4/manga?genres=${genreId}&order_by=popularity&sort=asc&limit=20&type=manga&sfw=false`;
    
    const res = await fetch(url);
    if (!res.ok) {
      if (res.status === 429 && retryCount < 3) {
        // Rate limited, retry with exponential backoff
        const delay = 1000 * Math.pow(2, retryCount);
        await new Promise(r => setTimeout(r, delay));
        return fetchGenre(genre, genreId, retryCount + 1);
      }
      throw new Error(`HTTP ${res.status}`);
    }
    
    const data = await res.json();
    if (!data.data || !data.data.length) return;

    let manga = data.data;

    // Color filtering
    if (selectedColor !== 'all') {
      manga = manga.filter(m => {
        const title = (m.title || '').toLowerCase();
        const synopsis = (m.synopsis || '').toLowerCase();
        const keywords = COLOR_KEYWORDS[selectedColor] || [];
        return keywords.some(kw => title.includes(kw) || synopsis.includes(kw));
      });
    }

    const carousel = $(`carousel-${genre}`);
    if (!carousel) return;

    if (manga.length === 0) {
      carousel.innerHTML = `<p style="color:var(--muted);font-size:11px;padding:1rem;font-style:italic;">no ${selectedColor} covers found. typical.</p>`;
      return;
    }

    carousel.innerHTML = manga.slice(0, 15).map(m => `
      <div class="genre-card" data-mal="${m.mal_id}">
        <img
          src="${m.images?.jpg?.image_url || ''}"
          alt="${escHtml(m.title)}"
          loading="lazy"
          onerror="this.src='${BLANK_SVG}'">
        <div class="genre-card-title">${escHtml(m.title)}</div>
        <div class="genre-card-score">
          <span class="star">▲</span> ${m.score || 'N/A'}
          <span style="margin-left:4px;color:var(--border)">|</span>
          ${m.volumes ? m.volumes + ' vol' : m.chapters ? m.chapters + ' ch' : '?'}
        </div>
      </div>
    `).join('');

    carousel.querySelectorAll('.genre-card').forEach((card, i) => {
      card.addEventListener('click', () => {
        const m = manga[i];
        window.location.href = `builder.html?add=${m.mal_id}`;
      });
    });

    loadedGenres.add(genre);

  } catch(e) {
    console.warn(`Genre "${genre}" failed:`, e);
    const carousel = $(`carousel-${genre}`);
    if (carousel) {
      carousel.innerHTML = `<p style="color:var(--muted);font-size:11px;padding:1rem;font-style:italic;">couldn't load these. not my fault.</p>`;
    }
  }
}

function reloadGenres() {
  loadGenres();
}

// Utils
function escHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function showNotif(msg, type = '') {
  const el = document.createElement('div');
  el.className = `notif${type ? ' ' + type : ''}`;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3200);
}

const TSUN_LINES = {
  onLoad: [
    "Don't get used to this.",
    "I compiled these covers by accident.",
    "It's not like I wanted you here.",
    "Whatever. Just look around."
  ]
};

function tsunLine(key) {
  const lines = TSUN_LINES[key] || ['...'];
  return lines[Math.floor(Math.random() * lines.length)];
}

// Init
loadGenres();
showNotif(tsunLine('onLoad'), 'blush');
</script>
</body>
</html>
